---
layout: post
title: Leadership election with cassandra
date: 2016-01-21 22:56:55.000000000 -08:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Code
tags:
- cassandra
- java
- leadership
- paradoxical
- quorum
meta:
  _edit_last: '1'
  _syntaxhighlighter_encoded: '1'
  _su_rich_snippet_type: none
  _wpas_done_all: '1'
  _jetpack_related_posts_cache: a:1:{s:32:"8f6677c9d6b0f903e98ad32ec61f8deb";a:2:{s:7:"expires";i:1560857090;s:7:"payload";a:3:{i:0;a:1:{s:2:"id";i:4800;}i:1;a:1:{s:2:"id";i:4750;}i:2;a:1:{s:2:"id";i:4783;}}}}
author:
  login: akropp
  email: akropp@gmail.com
  display_name: akropp
  first_name: ''
  last_name: ''
permalink: "/2016/01/21/leadership-election-cassandra/"
---
<p>Cassandra has a neat feature that lets you expire data in a column. Using this handy little feature, you can create simple leadership election using cassandra.  The whole process is <a href="http://www.datastax.com/dev/blog/consensus-on-cassandra">described here</a> which talks about leveraging Cassandras consensus and the column expiration to create leadership electors.</p>
<p>The idea is that a user will try and claim a slot for a period of time in a leadership table. If a slot is full, someone else has leadership.  While the leader is still active they needs to heartbeat the table faster than the columns TTL to act as a keepalive.  If it fails to heartbeat (i.e. it died) then its leadership claim can be relinquished and someone else can claim it.  Unlike most leadership algorithms that claim a single "host" as a leader, I needed a way to create leaders sharded by some "group". I call this a  "LeadershipGroup" and we can leverage the expiring columns in cassandra to do this!</p>
<p>To make this easier, I've wrapped this algorithm in a java library available <a href="https://github.com/paradoxical-io/cassandra.leadership">from paradoxical</a>. For the impatient</p>
<p>[java]<br />
&lt;dependency&gt;<br />
    &lt;groupId&gt;io.paradoxical&lt;/groupId&gt;<br />
    &lt;artifactId&gt;cassandra-leadership&lt;/artifactId&gt;<br />
    &lt;version&gt;1.0&lt;/version&gt;<br />
&lt;/dependency&gt;<br />
[/java]</p>
<p>The gist here is that you need to provide a schema similar to </p>
<p>[code]<br />
CREATE TABLE leadership_election (<br />
    group text PRIMARY KEY,<br />
    leader_id text<br />
);<br />
[/code]</p>
<p>Though the actual column names can be custom defined.  You can define a leadership election factory using Guice like so</p>
<p>[java]<br />
public class LeadershipModule extends AbstractModule {<br />
    @Override<br />
    protected void configure() {<br />
        bind(LeadershipSchema.class).toInstance(LeadershipSchema.Default);</p>
<p>        bind(LeadershipStatus.class).to(LeadershipStatusImpl.class);</p>
<p>        bind(LeadershipElectionFactory.class).to(CassandraLeadershipElectionFactory.class);<br />
    }<br />
}<br />
[/java]</p>
<ul>
<li><code>LeadershipStatus</code> is a class that lets you query who is leader for what "group". For example, you can have multiple workers competing for leadership of a certain resource.  </li>
<li><code>LeadershipSchema</code> is a class that defines what the column names in your schema are named. By default if you use the sample table above, the Default schema maps to that</li>
<li><code>LeadershipElectionFactory</code> is a class that gives you instances of LeadershipElection classes, and I've provided a cassandra leadership factory</li>
</ul>
<p>Once we have a leader election we can try and claim leadership:</p>
<p>[java]<br />
final LeadershipElectionFactory factory = new CassandraLeadershipElectionFactory(session);</p>
<p>// create an election processor for a group id<br />
final LeadershipElection leadership = factory.create(LeadershipGroup.random());</p>
<p>final LeaderIdentity user1 = LeaderIdentity.valueOf(&quot;user1&quot;);</p>
<p>final LeaderIdentity user2 = LeaderIdentity.valueOf(&quot;user2&quot;);</p>
<p>assertThat(leadership.tryClaimLeader(user1, Duration.ofSeconds(2))).isPresent();</p>
<p>Thread.sleep(Duration.ofSeconds(3).toMillis());</p>
<p>assertThat(leadership.tryClaimLeader(user2, Duration.ofSeconds(3))).isPresent();<br />
[/java]</p>
<p>When you claim leadership you claim it for a period of time and if you get it you get a leadership token that you can heartbeat on. And now you have leadership!</p>
<p>As usual, full source available at my <a href="https://github.com/paradoxical-io/cassandra.leadership">github</a></p>
